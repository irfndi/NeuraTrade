#!/bin/bash
#
# NeuraTrade CLI - Local configuration and onboarding tool
# Usage: neuratrade <command>
#
# This CLI manages ~/.neuratrade/ folder for:
# - Configuration files (env, yaml)
# - AI context files (skills, agents)
# - Local database
# - Channel configurations
#
# Similar to picoclaw approach: https://github.com/sipeed/picoclaw

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Constants
NEURATRADE_DIR="${NEURATRADE_DIR:-$HOME/.neuratrade}"
NEURATRADE_VERSION="1.0.0"

# Print functions
print_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
print_success() { echo -e "${GREEN}[OK]${NC} $*"; }
print_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
print_error() { echo -e "${RED}[ERROR]${NC} $*"; }
print_step() { echo -e "${CYAN}[STEP]${NC} $*"; }

# Show help
show_help() {
    cat <<EOF
NeuraTrade CLI v${NEURATRADE_VERSION}

Usage: neuratrade <command> [options]

Commands:
    onboard          Initialize NeuraTrade (first-time setup)
    onboarding       Alias for onboard
    init             Deprecated: use 'onboard' instead
    start            Start NeuraTrade server
    config           Show/edit configuration (JSON format)
    context          Manage AI context files
    workspace        Show workspace directory
    db               Database operations
    channel          Manage notification channels
    doctor           Diagnose configuration issues
    path             Show neuratrade directory path
    version          Show version
    logs             View/manage logs

Examples:
    neuratrade onboard              # First-time setup
    neuratrade start               # Start backend only
    neuratrade gateway             # Start all services (CCXT + Telegram + Backend)
    neuratrade stop                # Stop all services
    neuratrade logs                # View logs
    neuratrade doctor              # Check for issues

For more info: https://github.com/irfndi/neuratrade
EOF
}

# Create directory structure (matching picoclaw's workspace pattern)
create_directories() {
    print_step "Creating directory structure..."

    local dirs=(
        "${NEURATRADE_DIR}"
        "${NEURATRADE_DIR}/workspace"       # Main workspace (like picoclaw)
        "${NEURATRADE_DIR}/workspace/skills"    # Trading strategies
        "${NEURATRADE_DIR}/workspace/agents"    # Agent definitions
        "${NEURATRADE_DIR}/workspace/memory"     # Long-term memory
        "${NEURATRADE_DIR}/workspace/sessions"  # Conversation sessions
        "${NEURATRADE_DIR}/workspace/cron"      # Scheduled jobs
        "${NEURATRADE_DIR}/data"                 # Local database
        "${NEURATRADE_DIR}/logs"                 # Log files
    )

    for dir in "${dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            print_success "Exists: ${dir#$HOME/}"
        else
            mkdir -p "$dir"
            print_success "Created: ${dir#$HOME/}"
        fi
    done
}

# Generate default config (JSON format like picoclaw)
generate_config() {
    print_step "Generating default configuration..."

    # Main config.json (like picoclaw)
    if [[ ! -f "${NEURATRADE_DIR}/config.json" ]]; then
        cat > "${NEURATRADE_DIR}/config.json" <<'EOF'
{
  "version": "1.0.0",
  "database": {
    "url": "postgres://neuratrade:password@localhost:5432/neuratrade",
    "max_conns": 10,
    "max_idle_conns": 2,
    "sqlite_path": "~/.neuratrade/data/neuratrade.db"
  },
  "redis": {
    "url": "redis://localhost:6379"
  },
  "server": {
    "host": "0.0.0.0",
    "port": 8080,
    "environment": "development"
  },
  "services": {
    "ccxt": {
      "url": "http://localhost:3001"
    },
    "telegram": {
      "enabled": false,
      "bot_token": "",
      "api_base_url": "http://localhost:8080",
      "use_polling": true,
      "port": 3002
    }
  },
  "security": {
    "admin_api_key": "change-me-in-production"
  },
  "logging": {
    "level": "info",
    "file": "~/.neuratrade/logs/neuratrade.log"
  }
}
EOF
        print_success "Created: config.json"
    else
        print_warn "Skipping config.json (already exists)"
    fi

    # Workspace AI context files (like picoclaw's AGENTS.md, IDENTITY.md, etc.)

    # AGENTS.md - Agent behavior guide
    if [[ ! -f "${NEURATRADE_DIR}/workspace/AGENTS.md" ]]; then
        cat > "${NEURATRADE_DIR}/workspace/AGENTS.md" <<'EOF'
# NeuraTrade Agent Guide

You are NeuraTrade, an autonomous cryptocurrency trading system.

## Your Role

- Analyze market data from multiple exchanges
- Detect arbitrage opportunities (spot & futures)
- Execute trades based on signals
- Manage risk and portfolio

## Available Skills

See `skills/` directory for trading strategies.
EOF
        print_success "Created: workspace/AGENTS.md"
    fi

    # IDENTITY.md - Agent identity
    if [[ ! -f "${NEURATRADE_DIR}/workspace/IDENTITY.md" ]]; then
        cat > "${NEURATRADE_DIR}/workspace/IDENTITY.md" <<'EOF'
# NeuraTrade Identity

## Name
NeuraTrade

## Type
Autonomous Cryptocurrency Trading System

## Capabilities
- Real-time market data analysis
- Arbitrage detection (spot & funding)
- Technical analysis (RSI, MACD, Bollinger Bands)
- Risk management
- Portfolio optimization
EOF
        print_success "Created: workspace/IDENTITY.md"
    fi

    # SOUL.md - Agent personality
    if [[ ! -f "${NEURATRADE_DIR}/workspace/SOUL.md" ]]; then
        cat > "${NEURATRADE_DIR}/workspace/SOUL.md" <<'EOF'
# NeuraTrade Soul

## Principles
- Prioritize risk management over profits
- Always verify signals before execution
- Stay within configured limits
- Learn from losses

## Behavior
- Conservative in uncertain markets
- Transparent about errors
- Continuous monitoring
EOF
        print_success "Created: workspace/SOUL.md"
    fi

    # TOOLS.md - Tool descriptions
    if [[ ! -f "${NEURATRADE_DIR}/workspace/TOOLS.md" ]]; then
        cat > "${NEURATRADE_DIR}/workspace/TOOLS.md" <<'EOF'
# NeuraTrade Tools

## Trading Tools
- `place_order` - Execute a trade
- `cancel_order` - Cancel pending order
- `get_balance` - Check account balance
- `get_positions` - List open positions

## Analysis Tools
- `get_ticker` - Fetch price data
- `get_orderbook` - Fetch order book
- `calculate_indicators` - Technical analysis

## Risk Tools
- `check_risk_limits` - Verify within limits
- `get_portfolio_value` - Total portfolio value
EOF
        print_success "Created: workspace/TOOLS.md"
    fi

    # USER.md - User preferences
    if [[ ! -f "${NEURATRADE_DIR}/workspace/USER.md" ]]; then
        cat > "${NEURATRADE_DIR}/workspace/USER.md" <<'EOF'
# User Preferences

## Trading Parameters
- Max position size: [TO BE CONFIGURED]
- Risk tolerance: moderate
- Preferred exchanges: [TO BE CONFIGURED]

## Notifications
- Telegram enabled: false
- Alert on: arbitrage opportunities, risk events
EOF
        print_success "Created: workspace/USER.md"
    fi
}

# Setup context files (symlinks to project - like picoclaw's workspace approach)
setup_context() {
    print_step "Setting up AI context files..."

    local project_root
    project_root="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

    # Link AGENTS.md files from services
    local context_sources=(
        "services/backend-api/AGENTS.md:workspace/services/backend-api.md"
        "services/ccxt-service/AGENTS.md:workspace/services/ccxt-service.md"
        "services/telegram-service/AGENTS.md:workspace/services/telegram-service.md"
    )

    for item in "${context_sources[@]}"; do
        local src="${item%%:*}"
        local dest="${item##*:}"
        local full_src="${project_root}/${src}"
        local full_dest="${NEURATRADE_DIR}/${dest}"

        if [[ -f "$full_src" ]]; then
            # Create parent dir
            mkdir -p "$(dirname "$full_dest")"

            if [[ -L "$full_dest" ]]; then
                rm "$full_dest"
            fi

            ln -sf "$full_src" "$full_dest"
            print_success "Linked: ${dest} -> ${src}"
        else
            print_warn "Not found: ${full_src}"
        fi
    done

    # Link skills directory (trading strategies)
    local skills_src="${project_root}/services/backend-api/skills"
    local skills_dest="${NEURATRADE_DIR}/workspace/skills"

    if [[ -d "$skills_src" ]]; then
        mkdir -p "$(dirname "$skills_dest")"
        # Remove empty directory first, then link
        if [[ -d "$skills_dest" ]] && [[ -z "$(ls -A "$skills_dest")" ]]; then
            rmdir "$skills_dest"
        fi
        if [[ -L "$skills_dest" ]]; then
            rm "$skills_dest"
        fi
        if [[ -d "$skills_dest" ]]; then
            print_warn "Skills directory already has content, skipping link"
        else
            ln -sf "$skills_src" "$skills_dest"
            print_success "Linked: workspace/skills -> services/backend-api/skills"
        fi
    fi

    # Create workspace index
    if [[ ! -f "${NEURATRADE_DIR}/workspace/README.md" ]]; then
        cat > "${NEURATRADE_DIR}/workspace/README.md" <<EOF
# NeuraTrade Workspace

This directory contains AI context files and working data.

## Structure

- \`agents/\` - Agent behavior guides
- \`skills/\` - Trading strategies (symlinked to project)
- \`memory/\` - Long-term memory
- \`sessions/\` - Conversation history
- \`cron/\` - Scheduled tasks
- \`services/\` - Service-specific context (symlinked)

## Quick Links

EOF
        for svc in backend-api ccxt-service telegram-service; do
            if [[ -f "${NEURATRADE_DIR}/workspace/services/${svc}.md" ]]; then
                echo "- [${svc}](./services/${svc}.md)" >> "${NEURATRADE_DIR}/workspace/README.md"
            fi
        done

        print_success "Created: workspace/README.md"
    fi
}

# Start command - runs the NeuraTrade server with log management
cmd_start() {
    local service="${1:-all}"
    local log_dir="${NEURATRADE_DIR}/logs"

    # Ensure directories exist
    mkdir -p "${NEURATRADE_DIR}/data"
    mkdir -p "${log_dir}"

    # Rotate logs if they get too big (keep last 5, max 10MB each)
    rotate_logs() {
        local max_size=10485760  # 10MB
        local max_files=5

        for logfile in "$log_dir"/*.log; do
            [[ -f "$logfile" ]] || continue
            local size=$(stat -f%z "$logfile" 2>/dev/null || stat -c%s "$logfile" 2>/dev/null || echo 0)
            if [[ $size -gt $max_size ]]; then
                mv "$logfile" "${logfile}.old"
                print_info "Rotated: $(basename "$logfile")"
            fi
        done

        # Clean old rotated logs
        ls -t "$log_dir"/*.old 2>/dev/null | tail -n +$((max_files + 1)) | xargs rm -f 2>/dev/null || true
    }

    # Check if already running
    if pgrep -f "bin/server" > /dev/null 2>&1; then
        print_warn "NeuraTrade server is already running!"
        print_info "Use 'neuratrade stop' to stop it first"
        exit 1
    fi

    print_step "Starting NeuraTrade server..."
    echo "Log file: ${log_dir}/server.log"
    echo ""

    # Ensure data directory exists
    mkdir -p "${NEURATRADE_DIR}/data"

    # Extract config values
    local db_driver="sqlite"
    local db_path="${NEURATRADE_DIR}/data/neuratrade.db"

    # Load from config.json if exists
    local config_file="${NEURATRADE_DIR}/config.json"
    if [[ -f "$config_file" ]]; then
        # Simple JSON parsing with grep/sed
        db_driver=$(grep -o '"driver"[[:space:]]*:[[:space:]]*"[^"]*"' "$config_file" | head -1 | sed 's/.*"driver"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/')
        db_path=$(grep -o '"path"[[:space:]]*:[[:space:]]*"[^"]*"' "$config_file" | head -1 | sed 's/.*"\([^"]*\)"/\1/')

        # Expand ~ if present
        db_path="${db_path/#\~/$HOME}"
    fi

    # Set environment variables
    export DATABASE_DRIVER="$db_driver"
    export SQLITE_PATH="$db_path"
    export FULL_MODE=true

    # Rotate old logs before starting
    rotate_logs

    # Start the server
    cd "${NEURATRADE_DIR}" 2>/dev/null || cd "$(dirname "$NEURATRADE_DIR")"

    # Find the backend binary
    local binary=""
    for dir in "$(pwd)/services/backend-api/bin" "$HOME/neuratrade/bin" "./bin"; do
        if [[ -x "$dir/server" ]]; then
            binary="$dir/server"
            break
        fi
    done

    if [[ -z "$binary" ]]; then
        # Try to build if not found
        print_info "Building NeuraTrade server..."
        if [[ -d "services/backend-api" ]]; then
            cd services/backend-api
            if command -v go &> /dev/null; then
                go build -o bin/server ./cmd/server
                binary="bin/server"
                cd ../..
            fi
        fi
    fi

    if [[ -z "$binary" ]] || [[ ! -x "$binary" ]]; then
        print_error "Server binary not found!"
        print_info "Run 'make build' in services/backend-api first"
        exit 1
    fi

    # Load Telegram token from config
    local telegram_token=""
    local telegram_polling="true"
    local config_file="${NEURATRADE_DIR}/config.json"
    if [[ -f "$config_file" ]]; then
        telegram_token=$(grep -o '"bot_token"[[:space:]]*:[[:space:]]*"[^"]*"' "$config_file" | sed 's/.*"bot_token"[[:space:]]*:[[:space:]]*"\([^"]*\)"/\1/')
        telegram_polling=$(grep -o '"use_polling"[[:space:]]*:[[:space:]]*[^,}]*' "$config_file" | sed 's/.*:\s*\(true\|false\)/\1/')
    fi

    # Start services based on mode
    if [[ "$service" == "all" ]]; then
        print_step "Starting all services (gateway mode)..."

        # Start CCXT service
        print_info "Starting CCXT service..."
        if command -v bun &> /dev/null && [[ -d "services/ccxt-service" ]]; then
            cd services/ccxt-service
            nohup bun run index.ts >> "${log_dir}/ccxt.log" 2>&1 &
            cd ../..
            print_success "CCXT service started"
        else
            print_warn "Bun or CCXT service not found, skipping..."
        fi

        # Start Telegram service
        if [[ -n "$telegram_token" ]]; then
            print_info "Starting Telegram service..."
            cd services/telegram-service
            TELEGRAM_BOT_TOKEN="$telegram_token" \
            TELEGRAM_USE_POLLING="$telegram_polling" \
            nohup bun run index.ts >> "${log_dir}/telegram.log" 2>&1 &
            cd ../..
            print_success "Telegram service started"
        else
            print_warn "Telegram bot_token not configured, skipping..."
        fi

        sleep 2
    fi

    # Start backend server
    print_success "Starting backend server..."
    if [[ -n "$telegram_token" ]]; then
        TELEGRAM_BOT_TOKEN="$telegram_token" "$binary" >> "${log_dir}/server.log" 2>&1 &
    else
        "$binary" >> "${log_dir}/server.log" 2>&1 &
    fi
    local server_pid=$!

    sleep 3

    # Check if started successfully
    if curl -s http://localhost:8080/health > /dev/null 2>&1; then
        print_success "All services started successfully!"
        echo ""
        echo "Services:"
        echo "  - Backend API: http://localhost:8080"
        [[ "$service" == "all" ]] && echo "  - CCXT Service: http://localhost:3001"
        [[ "$service" == "all" ]] && echo "  - Telegram: http://localhost:3002"
        echo ""
        echo "Logs: ${log_dir}/"
        echo "View logs: neuratrade logs"
        echo "Stop: neuratrade stop"
    else
        print_error "Server failed to start!"
        print_info "Check logs: ${log_dir}/server.log"
        tail -20 "${log_dir}/server.log"
        exit 1
    fi
}

# Stop command
cmd_stop() {
    print_step "Stopping NeuraTrade services..."

    # Stop backend
    if pgrep -f "bin/server" > /dev/null 2>&1; then
        pkill -f "bin/server"
        print_success "Backend stopped"
    else
        print_warn "Backend is not running"
    fi

    # Stop bun services (CCXT, Telegram)
    if pgrep -f "bun" > /dev/null 2>&1; then
        pkill -f "bun"
        print_success "Bun services stopped"
    else
        print_warn "No bun services running"
    fi

    sleep 1
    print_success "All services stopped"
}

# Logs command - view and manage logs
cmd_logs() {
    local action="${1:-tail}"
    local log_dir="${NEURATRADE_DIR}/logs"
    local lines="${2:-50}"

    mkdir -p "$log_dir"

    case "$action" in
        tail)
            if [[ -f "${log_dir}/server.log" ]]; then
                tail -n "$lines" "${log_dir}/server.log"
            else
                print_warn "No logs found at: ${log_dir}/server.log"
                print_info "Start server first: neuratrade start"
            fi
            ;;
        head)
            if [[ -f "${log_dir}/server.log" ]]; then
                head -n "$lines" "${log_dir}/server.log"
            else
                print_warn "No logs found"
            fi
            ;;
        watch)
            if command -v tail &> /dev/null; then
                tail -f "${log_dir}/server.log"
            else
                print_error "tail command not found"
            fi
            ;;
        clean|cleanup)
            print_step "Cleaning old logs..."
            find "$log_dir" -name "*.log" -mtime +7 -delete 2>/dev/null || true
            find "$log_dir" -name "*.old" -mtime +1 -delete 2>/dev/null || true
            print_success "Old logs cleaned up"
            ;;
        list|ls)
            print_info "Log files in ${log_dir}:"
            ls -lah "$log_dir" 2>/dev/null || print_warn "No logs directory"
            ;;
        path)
            echo "$log_dir"
            ;;
        *)
            print_error "Unknown log action: $action"
            echo "Usage: neuratrade logs [tail|head|watch|clean|list|path] [lines]"
            exit 1
            ;;
    esac
}

# Initialize command (like picoclaw's onboard)
cmd_onboard() {
    echo ""
    echo -e "${CYAN}╔════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║     NeuraTrade Initialization         ║${NC}"
    echo -e "${CYAN}╚════════════════════════════════════════╝${NC}"
    echo ""
    echo "Installing to: ${NEURATRADE_DIR}"
    echo ""

    if [[ -d "${NEURATRADE_DIR}" && -f "${NEURATRADE_DIR}/config.json" ]]; then
        print_warn "NeuraTrade is already initialized!"
        read -p "Re-initialize? [y/N] " -n 1 -r reply
        echo
        if [[ ! $reply =~ ^[Yy]$ ]]; then
            print_info "Aborted."
            exit 0
        fi
    fi

    create_directories
    generate_config
    setup_context

    echo ""
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${GREEN}  Initialization complete!${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit config: ${NEURATRADE_DIR}/config.json"
    echo "  2. Configure Telegram bot token"
    echo "  3. Run: neuratrade doctor"
    echo ""
    echo "Quick commands:"
    echo "  neuratrade config show    # View config"
    echo "  neuratrade workspace      # Show workspace"
    echo "  neuratrade doctor        # Check for issues"
    echo ""
}

# Show config command (JSON like picoclaw)
cmd_config() {
    local action="${1:-show}"

    case "$action" in
        show)
            if [[ -f "${NEURATRADE_DIR}/config.json" ]]; then
                cat "${NEURATRADE_DIR}/config.json"
            else
                print_error "Config not found. Run 'neuratrade onboard' first."
                exit 1
            fi
            ;;
        edit)
            ${EDITOR:-vim} "${NEURATRADE_DIR}/config.json"
            ;;
        path)
            echo "${NEURATRADE_DIR}/config.json"
            ;;
        *)
            print_error "Unknown config action: $action"
            echo "Usage: neuratrade config [show|edit|path]"
            exit 1
            ;;
    esac
}

# Workspace command
cmd_workspace() {
    echo "${NEURATRADE_DIR}/workspace"
}

# Context command - list AI context files
cmd_context() {
    local action="${1:-list}"

    case "$action" in
        list|ls)
            print_info "AI Context files in workspace:"
            echo ""
            ls -la "${NEURATRADE_DIR}/workspace/" 2>/dev/null || print_warn "Workspace not initialized"
            echo ""
            print_info "Services context:"
            ls -la "${NEURATRADE_DIR}/workspace/services/" 2>/dev/null || print_warn "No service context linked"
            echo ""
            print_info "Skills:"
            ls -la "${NEURATRADE_DIR}/workspace/skills/" 2>/dev/null || print_warn "No skills linked"
            ;;
        path)
            echo "${NEURATRADE_DIR}/workspace"
            ;;
        *)
            print_error "Unknown context action: $action"
            echo "Usage: neuratrade context [list|path]"
            exit 1
            ;;
    esac
}

# Doctor command - diagnose issues
cmd_doctor() {
    print_info "Running diagnostics..."
    echo ""

    local issues=0

    # Check directory
    if [[ -d "${NEURATRADE_DIR}" ]]; then
        print_success "NeuraTrade directory exists: ${NEURATRADE_DIR}"
    else
        print_error "NeuraTrade directory not found: ${NEURATRADE_DIR}"
        print_info "Run 'neuratrade onboard' to set up"
        ((issues++))
    fi

    # Check config.json
    if [[ -f "${NEURATRADE_DIR}/config.json" ]]; then
        print_success "Config file exists (config.json)"

        # Check for default values
        if grep -q '"admin_api_key": "change-me' "${NEURATRADE_DIR}/config.json" 2>/dev/null; then
            print_warn "admin_api_key is still set to default value"
            ((issues++))
        fi

        # Check Telegram config
        if grep -q '"bot_token": ""' "${NEURATRADE_DIR}/config.json" 2>/dev/null; then
            print_warn "Telegram bot_token not configured"
        fi
    else
        print_error "Config file not found (config.json)"
        ((issues++))
    fi

    # Check workspace
    if [[ -d "${NEURATRADE_DIR}/workspace" ]]; then
        print_success "Workspace directory exists"

        # Check for key context files
        for file in AGENTS.md IDENTITY.md SOUL.md TOOLS.md USER.md; do
            if [[ -f "${NEURATRADE_DIR}/workspace/$file" ]]; then
                print_success "  - $file exists"
            else
                print_warn "  - $file missing"
            fi
        done
    else
        print_warn "Workspace directory not found"
    fi

    # Check data directory
    if [[ -d "${NEURATRADE_DIR}/data" ]]; then
        print_success "Data directory exists"
    else
        print_warn "Data directory not found"
    fi

    echo ""
    if [[ $issues -eq 0 ]]; then
        print_success "All checks passed!"
    else
        print_warn "Found $issues issue(s)"
    fi
}

# Path command
cmd_path() {
    echo "${NEURATRADE_DIR}"
}

# Version command
cmd_version() {
    echo "NeuraTrade CLI v${NEURATRADE_VERSION}"
}

# Main dispatcher
main() {
    local cmd="${1:-help}"
    shift 2>/dev/null || true

    case "$cmd" in
        onboard|onboarding|init)
            cmd_onboard
            ;;
        start)
            cmd_start "backend"
            ;;
        gateway)
            cmd_start "all"
            ;;
        stop)
            cmd_stop
            ;;
        logs)
            cmd_logs "$@"
            ;;
        config)
            cmd_config "$@"
            ;;
        context)
            cmd_context "$@"
            ;;
        workspace)
            cmd_workspace
            ;;
        db)
            # TODO: implement db commands
            print_info "Database is at: ${NEURATRADE_DIR}/data/neuratrade.db"
            ;;
        channel)
            # TODO: implement channel commands
            print_info "Channel config is in: ${NEURATRADE_DIR}/config.json"
            ;;
        doctor)
            cmd_doctor
            ;;
        path)
            cmd_path
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h)
            show_help
            ;;
        *)
            print_error "Unknown command: $cmd"
            echo
            show_help
            exit 1
            ;;
    esac
}

main "$@"
