# NeuraTrade - Docker Compose for Local Development and Production
# All services are built from the services/ directory
#
# Usage (one command to start):
#   docker compose --env-file ~/.neuratrade/.env --profile local up -d --build
#
# Stop:
#   docker compose --env-file ~/.neuratrade/.env down
#
# Environment variables (set in ~/.neuratrade/.env):
#   - NEURATRADE_HOME: Absolute path to config+data directory (default: ~/.neuratrade)
#   - BACKEND_HOST_PORT: Host port for backend API (default: 58080)
#   - DATABASE_DRIVER: sqlite or postgres (default: sqlite)
#   - SQLITE_DB_PATH: Path inside container (default: /data/neuratrade.db)

services:
  backend-api:
    build:
      context: services/backend-api
      dockerfile: Dockerfile
    restart: always
    ports:
      - "${BACKEND_HOST_PORT:-58080}:8080"
    environment:
      # Database configuration - SQLite by default
      - DATABASE_DRIVER=${DATABASE_DRIVER:-sqlite}
      - SQLITE_DB_PATH=${SQLITE_DB_PATH:-/data/neuratrade.db}
      # PostgreSQL configuration (optional - only if DATABASE_DRIVER=postgres)
      - DATABASE_HOST=${DATABASE_HOST:-}
      - DATABASE_PORT=${DATABASE_PORT:-5432}
      - DATABASE_USER=${DATABASE_USER:-postgres}
      - DATABASE_PASSWORD=${DATABASE_PASSWORD:-}
      - DATABASE_DBNAME=${DATABASE_DBNAME:-neuratrade}
      # Redis configuration
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - PORT=8080
      # Service URLs (internal Docker network)
      - CCXT_SERVICE_URL=${CCXT_SERVICE_URL:-http://ccxt-service:3001}
      - CCXT_GRPC_ADDRESS=${CCXT_GRPC_ADDRESS:-ccxt-service:50051}
      - TELEGRAM_SERVICE_URL=${TELEGRAM_SERVICE_URL:-http://telegram-service:3002}
      - TELEGRAM_GRPC_ADDRESS=${TELEGRAM_GRPC_ADDRESS:-telegram-service:50052}
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret}
      - EXTERNAL_CONNECTIONS_ENABLED=${EXTERNAL_CONNECTIONS_ENABLED:-false}
      - TELEGRAM_EXTERNAL_SERVICE=true
      - RUN_MIGRATIONS=${RUN_MIGRATIONS:-true}
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      - NODE_ENV=${NODE_ENV:-development}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
      - SENTRY_DSN=${SENTRY_DSN:-}
    volumes:
      - ${NEURATRADE_HOME:-${HOME}/.neuratrade}/data:/data
    networks:
      - default
      - coolify
    depends_on:
      ccxt-service:
        condition: service_started
      telegram-service:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Local development redis - only started with --profile local
  redis:
    image: redis:7-alpine
    profiles: ["local"]
    restart: always
    volumes:
      - ${NEURATRADE_HOME:-${HOME}/.neuratrade}/redis-data:/data
    networks:
      - default
      - coolify
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  ccxt-service:
    build:
      context: services/ccxt-service
      dockerfile: Dockerfile
    restart: always
    environment:
      - PORT=3001
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      - NODE_ENV=${NODE_ENV:-development}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
      - SENTRY_DSN=${SENTRY_DSN:-}
    networks:
      - default
      - coolify
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  telegram-service:
    build:
      context: services/telegram-service
      dockerfile: Dockerfile
    restart: always
    environment:
      - PORT=3002
      - TELEGRAM_PORT=3002
      # Support both TELEGRAM_BOT_TOKEN and TELEGRAM_TOKEN for compatibility
      # Note: The service handles fallback internally; prefer TELEGRAM_BOT_TOKEN
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN:-}
      - TELEGRAM_WEBHOOK_URL=${TELEGRAM_WEBHOOK_URL:-}
      - TELEGRAM_WEBHOOK_SECRET=${TELEGRAM_WEBHOOK_SECRET:-}
      - TELEGRAM_USE_POLLING=${TELEGRAM_USE_POLLING:-true}
      - TELEGRAM_WEBHOOK_PATH=${TELEGRAM_WEBHOOK_PATH:-/telegram/webhook}
      - TELEGRAM_API_BASE_URL=http://backend-api:8080
      - ADMIN_API_KEY=${ADMIN_API_KEY:-}
      - NODE_ENV=${NODE_ENV:-development}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
      - SENTRY_DSN=${SENTRY_DSN:-}
    networks:
      - default
      - coolify
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

networks:
  coolify:
    external: true
    name: ${COOLIFY_SHARED_NETWORK:-coolify}

